# SVN Hook 自动部署说明

## 核心功能

一键部署 SVN post-commit hook 到所有仓库，**自动配置** API 地址和仓库 URL。

## 快速使用

### 首次部署

```batch
1. 编辑 deploy_config.bat
   - 设置 REPOSITORIES_PATH（仓库路径）
   - 设置 REVIEW_API_URL（审查API地址）
   - 设置 SVN_SERVER_URL（SVN服务器地址）
   - 确保 SKIP_EXISTING=1

2. 运行部署脚本
   deploy_hooks_to_all_repos.bat
```

### 更新配置

```batch
1. 修改 deploy_config.bat 中的配置
2. 设置 SKIP_EXISTING=0
3. 运行 deploy_hooks_to_all_repos.bat
```

## 配置示例

```batch
# 仓库路径（可以是仓库集合目录或单个仓库）
set REPOSITORIES_PATH=D:\Repositories

# API地址
set REVIEW_API_URL=http://10.10.9.12:5001/review/webhook

# SVN服务器地址（不含仓库名）
set SVN_SERVER_URL=http://shimmer:8888/svn

# 首次部署=1，更新配置=0
set SKIP_EXISTING=1
```

## 自动配置原理

脚本会自动修改每个仓库的 `hooks/svn_post_commit_hook.py`：

```python
# 自动设置API地址
REVIEW_API_URL = os.getenv('SVN_REVIEW_API_URL', "http://10.10.9.12:5001/review/webhook")

# 自动生成仓库URL（根据仓库名称）
REPO_URL = os.getenv('SVN_REPO_URL', "http://shimmer:8888/svn/MyRepo/")
```

## SKIP_EXISTING 参数说明

| 值 | 场景 | 行为 |
|----|------|------|
| 1 | 首次部署 | 跳过已存在 hook 的仓库，避免覆盖 |
| 0 | 更新配置 | 覆盖所有仓库的 hook，批量更新配置 |

## 部署结果

```
D:\Repositories\
├── IdleEnchantment\
│   └── hooks\
│       ├── post-commit.bat
│       └── svn_post_commit_hook.py  ← 已自动配置
├── TestProject\
│   └── hooks\
│       ├── post-commit.bat
│       └── svn_post_commit_hook.py  ← 已自动配置
└── ...
```

## 验证部署

提交代码测试：

```bash
svn commit -m "test hook"
```

检查：
1. AI 代码审查系统是否收到 webhook
2. 审查结果是否正常生成

## 常见问题

### Q: 如何只部署到特定仓库？

A: 将 `REPOSITORIES_PATH` 设置为该仓库的完整路径：
```batch
set REPOSITORIES_PATH=D:\Repositories\MyProject
```

### Q: 如何更换 API 地址？

A: 修改 `deploy_config.bat` 中的 `REVIEW_API_URL`，设置 `SKIP_EXISTING=0`，重新运行脚本。

### Q: 如何恢复默认配置？

A: 删除仓库 `hooks` 目录下的文件，重新部署。

### Q: 支持环境变量吗？

A: 支持。环境变量优先级高于配置文件：
```batch
setx SVN_REVIEW_API_URL "http://custom:5001/review/webhook"
setx SVN_REPO_URL "http://custom-svn/svn/SpecialRepo/"
```

## 文件说明

| 文件 | 说明 |
|------|------|
| deploy_config.bat | 配置文件（需要修改） |
| deploy_hooks_to_all_repos.bat | 部署脚本（运行此文件） |
| post-commit.bat | SVN hook 入口文件 |
| svn_post_commit_hook.py | Hook 主逻辑（Python） |
| README.md | 完整文档 |
| QUICK_REFERENCE.md | 快速参考 |

## 技术支持

详细文档：[README.md](README.md)

快速参考：[QUICK_REFERENCE.md](QUICK_REFERENCE.md)
